#pragma once

#include "common/ccsds/ccsds.h"
#include "common/repack.h"
#include "image/image.h"
#include "nlohmann/json.hpp"
#include <cstdint>

namespace metopsg
{
    namespace sentinel5
    {
        class Sentinel5Reader
        {
        private:
            struct channel_t
            {
                int mkr;
                int mkr2;
                int bits;
                int offset;
                std::vector<int> pktsize;

                std::vector<uint16_t> img = {};
                int lines = 0;
            };

            std::vector<channel_t> all_channels = {
                // APID 1329 - 140
                {140, 1, 17, 54, {15133}}, //
                {140, 2, 17, 54, {15133}}, //
                {140, 3, 17, 54, {15590}}, //

                {140, 4, 19, 54, {294}}, //
                {140, 5, 19, 54, {294}}, //
                {140, 6, 19, 54, {294}}, //
                {140, 7, 19, 54, {294}}, //

                // APID 1329 - 141
                {141, 1, 16, 42, {508}}, //
                {141, 2, 16, 42, {508}}, //

                {141, 11, 16, 42, {128}}, //
                {141, 12, 16, 42, {128}}, //

                // APID 1330 - 145
                {145, 1, 17, 54, {14220}}, //
                {145, 2, 17, 54, {14220}}, //
                {145, 3, 17, 54, {15133}}, //

                {145, 4, 19, 54, {280}}, //
                {145, 5, 19, 54, {284}}, //
                {145, 6, 19, 54, {280}}, //
                {145, 7, 19, 54, {284}}, //

                // APID 1330 - 146
                {146, 1, 16, 42, {508}}, //
                {146, 2, 16, 42, {508}}, //
                {146, 3, 16, 42, {276}}, //
                {146, 4, 16, 42, {276}}, //

                {146, 11, 16, 42, {128}}, //
                {146, 12, 16, 42, {128}}, //

                // APID 1331 - 150
                {150, 1, 18, 54, {65529, 37616}}, //
                {150, 2, 18, 54, {65529, 37616}}, //
                {150, 3, 18, 54, {65529, 37616}}, //

                {150, 4, 19, 54, {4588}}, //
                {150, 5, 19, 54, {4588}}, //
                {150, 6, 19, 54, {4588}}, //
                {150, 7, 19, 54, {4588}}, //

                // APID 1331 - 151
                {151, 1, 16, 42, {2820}}, //
                {151, 2, 16, 42, {2820}}, //
                {151, 3, 16, 42, {1432}}, //
                {151, 4, 16, 42, {1432}}, //

                {151, 11, 16, 42, {132}}, //
                {151, 12, 16, 42, {132}}, //

                // APID 1332 - 155
                {155, 1, 18, 54, {65529, 39074}}, //
                {155, 2, 18, 54, {65529, 39074}}, //
                {155, 3, 18, 54, {65529, 39074}}, //

                {155, 4, 19, 54, {4659}}, //
                {155, 5, 19, 54, {4659}}, //
                {155, 6, 19, 54, {4659}}, //
                {155, 7, 19, 54, {4659}}, //

                // APID 1332 - 156
                {156, 1, 16, 42, {2820}}, //
                {156, 2, 16, 42, {2820}}, //
                {156, 3, 16, 42, {1432}}, //
                {156, 4, 16, 42, {1432}}, //
                {156, 5, 16, 42, {1432}}, //
                {156, 6, 16, 42, {1432}}, //

                {156, 11, 16, 42, {132}}, //
                {156, 12, 16, 42, {132}}, //

                // APID 1333 - 160
                {160, 1, 18, 54, {33104}}, //
                {160, 2, 18, 54, {33104}}, //
                {160, 3, 18, 54, {33590}}, //
                {160, 4, 19, 54, {1510}},  //
                {160, 5, 19, 54, {1524}},  //
                {160, 6, 19, 54, {1510}},  //
                {160, 7, 19, 54, {1524}},  //

                // APID 1333 - 161
                {161, 1, 16, 42, {2820}}, //
                {161, 2, 16, 42, {2820}}, //
                {161, 3, 16, 42, {1432}}, //
                {161, 4, 16, 42, {1432}}, //
                {161, 5, 16, 42, {1432}}, //

                {161, 11, 16, 42, {132}}, //
                {161, 12, 16, 42, {132}}, //

                // APID 1334 - 165
                {165, 1, 18, 54, {42824}},                      //
                {165, 2, 16, 54, {65530, 65530, 65530, 10034}}, //
                {165, 3, 16, 54, {65530, 65530, 65530, 10034}}, //
                {165, 4, 19, 54, {1823}},                       //
                {165, 5, 19, 54, {1823}},                       //
                {165, 6, 19, 54, {1823}},                       //
                {165, 7, 19, 54, {1823}},                       //

                // APID 1334 - 166
                {166, 1, 16, 42, {2820}}, //
                {166, 2, 16, 42, {2820}}, //
                {166, 3, 16, 42, {1432}}, //
                {166, 4, 16, 42, {1432}}, //
                {166, 5, 16, 42, {1432}}, //
                {166, 6, 16, 42, {1432}}, //
                {166, 7, 16, 42, {1432}}, //
                {166, 8, 16, 42, {1432}}, //

                {166, 11, 16, 42, {132}}, //
                {166, 12, 16, 42, {132}}, //

                // APID 1335 - 170
                {170, 1, 16, 54, {65530, 65530, 2596}}, //
                {170, 2, 16, 54, {65530, 65530, 2596}}, //
                {170, 3, 16, 54, {65530, 65530, 3028}}, //
                {170, 4, 19, 54, {9974}},               //
                {170, 5, 19, 54, {9974}},               //
                {170, 6, 19, 54, {9974}},               //
                {170, 7, 19, 54, {9974}},               //

                // APID 1335 - 171
                {171, 3, 16, 42, {1028}}, //
                {171, 4, 16, 42, {1028}}, //
                {171, 5, 16, 42, {1028}}, //
                {171, 6, 16, 42, {1028}}, //
                {171, 7, 16, 42, {1028}}, //
                {171, 8, 16, 42, {1028}}, //

                {171, 11, 16, 42, {124}}, //
                {171, 12, 16, 42, {124}}, //

                // APID 1336 - 180
                {180, 1, 16, 54, {65530, 62022}}, //
                {180, 2, 16, 54, {65530, 62022}}, //
                {180, 3, 16, 54, {65530, 62886}}, //
                {180, 4, 19, 54, {9526}},         //
                {180, 5, 19, 54, {9547}},         //
                {180, 6, 19, 54, {9526}},         //
                {180, 7, 19, 54, {9547}},         //

                // APID 1336 - 181
                {181, 3, 16, 42, {1028}}, //
                {181, 4, 16, 42, {1028}}, //
                {181, 5, 16, 42, {1028}}, //
                {181, 6, 16, 42, {1028}}, //
                {181, 7, 16, 42, {1028}}, //
                {181, 8, 16, 42, {1028}}, //

                {181, 11, 16, 42, {124}}, //
                {181, 12, 16, 42, {124}}, //
            };

            void parseLine(channel_t &ch, ccsds::CCSDSPacket pkt, int bits, int offset)
            {
                if (bits == 17 || bits == 18 || bits == 19 || bits == 20)
                {
                    int len = ((pkt.payload.size() - offset) * 8 / bits);
                    std::vector<uint32_t> output_buffer(len);
                    if (bits == 17)
                        repackBytesTo17bits(pkt.payload.data() + offset, pkt.payload.size() - offset - 2, output_buffer.data());
                    else if (bits == 18)
                        repackBytesTo18bits(pkt.payload.data() + offset, pkt.payload.size() - offset - 2, output_buffer.data());
                    else if (bits == 19)
                        repackBytesTo19bits(pkt.payload.data() + offset, pkt.payload.size() - offset - 2, output_buffer.data());
                    else if (bits == 20)
                        repackBytesTo20bits(pkt.payload.data() + offset, pkt.payload.size() - offset - 2, output_buffer.data());
                    for (int i = 0; i < len; i++)
                        ch.img.push_back(output_buffer[i] >> (bits - 16));
                }
                else if (bits == 16 || bits == 8)
                {
                    int len = (pkt.payload.size() - offset - 2) / (bits == 16 ? 2 : 1);

                    for (int i = 0; i < len; i++)
                    {
                        uint16_t v = 0;
                        if (bits == 16)
                            v = pkt.payload[offset + i * 2 + 0] << 8 | pkt.payload[offset + i * 2 + 1];
                        else
                            v = pkt.payload[offset + i] << 8;
                        ch.img.push_back(v);
                    }
                }
            }

        private:
            std::map<int, std::vector<ccsds::CCSDSPacket>> reassembled_pkts;
            // nlohmann::json all_pkts;

            void work2(std::vector<ccsds::CCSDSPacket> packet);

        public:
            Sentinel5Reader();
            ~Sentinel5Reader();
            void work(ccsds::CCSDSPacket packet);

            const int nchannels = all_channels.size(); // 113;

            int total_packets = 0;

            image::Image getChannel(int idx, std::string &name);
        };
    } // namespace sentinel5
} // namespace metopsg